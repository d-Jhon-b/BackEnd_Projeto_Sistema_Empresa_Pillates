"""create_index_tables

Revision ID: 1a9a41045822
Revises: f479641b1064
Create Date: 2025-10-11 16:55:24.266644

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision: str = '1a9a41045822'
down_revision: Union[str, Sequence[str], None] = 'f479641b1064'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    """Upgrade schema. Adiciona índices nas colunas de Chave Estrangeira (FKs)."""
    
    # 1. ÍNDICES DE DETALHES DO USUÁRIO
    op.create_index(op.f('ix_endereco_fk_id_user'), 'endereco', ['fk_id_user'], unique=False)
    op.create_index(op.f('ix_contato_fk_id_user'), 'contato', ['fk_id_user'], unique=False)
    
    # 2. ÍNDICES DE PAPÉIS (UNIQUE, pois um usuário só pode ser um de cada tipo de papel)
    op.create_index(op.f('ix_estudante_fk_id_user'), 'estudante', ['fk_id_user'], unique=True) 
    op.create_index(op.f('ix_professor_fk_id_user'), 'professor', ['fk_id_user'], unique=True) 
    op.create_index(op.f('ix_administracao_fk_id_user'), 'administracao', ['fk_id_user'], unique=True) 
    op.create_index(op.f('ix_recepcionista_fk_id_user'), 'recepcionista', ['fk_id_user'], unique=True) 
    op.create_index(op.f('ix_adm_plus_fk_id_user'), 'adm_plus', ['fk_id_user'], unique=True) 

    # 3. ÍNDICES DE LIGAÇÃO E REGISTRO
    op.create_index(op.f('ix_registro_aluno_fk_id_estudante'), 'registro_do_aluno', ['fk_id_estudante'], unique=False)
    op.create_index(op.f('ix_registro_aluno_fk_id_professor'), 'registro_do_aluno', ['fk_id_professor'], unique=False)
    
    op.create_index(op.f('ix_prof_estudante_fk_id_estudante'), 'professor_estudante', ['fk_id_estudante'], unique=False)
    op.create_index(op.f('ix_prof_estudante_fk_id_professor'), 'professor_estudante', ['fk_id_professor'], unique=False)
    
    # 4. ÍNDICES DE AULAS
    op.create_index(op.f('ix_aula_fk_id_estudio'), 'aula', ['fk_id_estudio'], unique=False)
    op.create_index(op.f('ix_aula_fk_id_professor'), 'aula', ['fk_id_professor'], unique=False)
    # ADICIONADO: FK de professor substituto também deve ser indexada
    op.create_index(op.f('ix_aula_fk_id_professor_subst'), 'aula', ['fk_id_professor_substituto'], unique=False) 

    op.create_index(op.f('ix_estudante_aula_fk_id_estudante'), 'estudante_aula', ['fk_id_estudante'], unique=False)
    op.create_index(op.f('ix_estudante_aula_fk_id_aula'), 'estudante_aula', ['fk_id_aula'], unique=False)
    
    # 5. ÍNDICES FINANCEIROS
    # CORRIGIDO: O índice deve ser sobre a FK correta (fk_id_estudante)
    op.create_index(op.f('ix_adesao_plano_fk_id_estudante'), 'adesao_plano', ['fk_id_estudante'], unique=False)

    op.create_index(op.f('ix_contrato_fk_id_estudante'), 'contrato', ['fk_id_estudante'], unique=False)
    op.create_index(op.f('ix_contrato_fk_id_plano'), 'contrato', ['fk_id_plano'], unique=False)
    # ADICIONADO: Índice para a FK da adesão
    op.create_index(op.f('ix_contrato_fk_id_adesao'), 'contrato', ['fk_id_adesao_plano'], unique=False)

    op.create_index(op.f('ix_venda_extra_fk_id_estudante'), 'venda_extra', ['fk_id_estudante'], unique=False)
    
    op.create_index(op.f('ix_pagamento_fk_id_contrato'), 'pagamento', ['fk_id_contrato'], unique=False)
    op.create_index(op.f('ix_pagamento_fk_id_estudante'), 'pagamento', ['fk_id_estudante'], unique=False)
    op.create_index(op.f('ix_pagamento_fk_id_venda_extra'), 'pagamento', ['fk_id_venda_extra'], unique=False)
    
    # 6. ÍNDICES DE SOLICITAÇÕES
    op.create_index(op.f('ix_solicitacoes_fk_id_user'), 'solicitacoes', ['fk_id_user'], unique=False)
    op.create_index(op.f('ix_solicitacoes_fk_id_estudio'), 'solicitacoes', ['fk_id_estudio'], unique=False)
    # Índice adicional (bom para consultas de status)
    op.create_index(op.f('ix_solicitacoes_status'), 'solicitacoes', ['status_solicitacao'], unique=False)


def downgrade() -> None:
    """Downgrade schema. Remove os índices criados."""

    # 1. Remoção de Índices de SOLICITAÇÕES
    op.drop_index(op.f('ix_solicitacoes_status'), table_name='solicitacoes')
    op.drop_index(op.f('ix_solicitacoes_fk_id_estudio'), table_name='solicitacoes')
    op.drop_index(op.f('ix_solicitacoes_fk_id_user'), table_name='solicitacoes')
    
    # 2. Remoção de Índices Financeiros
    op.drop_index(op.f('ix_pagamento_fk_id_venda_extra'), table_name='pagamento')
    op.drop_index(op.f('ix_pagamento_fk_id_estudante'), table_name='pagamento')
    op.drop_index(op.f('ix_pagamento_fk_id_contrato'), table_name='pagamento')
    
    op.drop_index(op.f('ix_venda_extra_fk_id_estudante'), table_name='venda_extra')

    # REMOVIDO: Índice para a FK da adesão
    op.drop_index(op.f('ix_contrato_fk_id_adesao'), table_name='contrato')
    op.drop_index(op.f('ix_contrato_fk_id_plano'), table_name='contrato')
    op.drop_index(op.f('ix_contrato_fk_id_estudante'), table_name='contrato')

    # CORRIGIDO: Remoção do índice com o nome correto
    op.drop_index(op.f('ix_adesao_plano_fk_id_estudante'), table_name='adesao_plano') 

    # 3. Remoção de Índices de Aulas
    op.drop_index(op.f('ix_estudante_aula_fk_id_aula'), table_name='estudante_aula')
    op.drop_index(op.f('ix_estudante_aula_fk_id_estudante'), table_name='estudante_aula')

    # REMOVIDO: Índice para FK de professor substituto
    op.drop_index(op.f('ix_aula_fk_id_professor_subst'), table_name='aula')
    op.drop_index(op.f('ix_aula_fk_id_professor'), table_name='aula')
    op.drop_index(op.f('ix_aula_fk_id_estudio'), table_name='aula')
    
    # 4. Remoção de Índices de Registro e Ligação
    op.drop_index(op.f('ix_prof_estudante_fk_id_professor'), table_name='professor_estudante')
    op.drop_index(op.f('ix_prof_estudante_fk_id_estudante'), table_name='professor_estudante')

    op.drop_index(op.f('ix_registro_aluno_fk_id_professor'), table_name='registro_do_aluno')
    op.drop_index(op.f('ix_registro_aluno_fk_id_estudante'), table_name='registro_do_aluno')

    # 5. Remoção de Índices de Papéis
    op.drop_index(op.f('ix_adm_plus_fk_id_user'), table_name='adm_plus')
    op.drop_index(op.f('ix_recepcionista_fk_id_user'), table_name='recepcionista')
    op.drop_index(op.f('ix_administracao_fk_id_user'), table_name='administracao')
    op.drop_index(op.f('ix_professor_fk_id_user'), table_name='professor')
    op.drop_index(op.f('ix_estudante_fk_id_user'), table_name='estudante')

    # 6. Remoção de Índices de detalhes do Usuário
    op.drop_index(op.f('ix_contato_fk_id_user'), table_name='contato')
    op.drop_index(op.f('ix_endereco_fk_id_user'), table_name='endereco')